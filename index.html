<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiosk Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to the external CSS file -->
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div class="container mx-auto max-w-3xl p-4 pt-8">
        
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Pi Kiosk Control Panel</h1>
            <p class="text-gray-600 mb-6">Manage your kiosk settings below. Changes are saved automatically.</p>

            <!-- Status Indicator -->
            <div class="mb-6 p-4 rounded-lg flex items-center" id="status-indicator">
                <div class="spinner" id="status-spinner"></div>
                <span class="ml-3 text-lg font-medium" id="status-text">Loading...</span>
            </div>

            <!-- ON Hours Settings -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">"ON" Hours Settings</h2>
                
                <div class="space-y-4" id="on-urls-container">
                    <!-- URL inputs will be dynamically added here -->
                </div>
                
                <button id="add-url-btn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow transition-all">
                    + Add URL
                </button>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div>
                        <label for="rotation_time_seconds" class="block text-sm font-medium text-gray-700">Rotation Time (seconds)</label>
                        <input type="number" id="rotation_time_seconds" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="on_hours_start" class="block text-sm font-medium text-gray-700">Start Time (24h)</label>
                        <input type="time" id="on_hours_start" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="on_hours_end" class="block text-sm font-medium text-gray-700">End Time (24h)</label>
                        <input type="time" id="on_hours_end" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- OFF Hours Settings -->
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-3">"OFF" Hours Settings</h2>
                <div>
                    <label for="off_hours_url" class="block text-sm font-medium text-gray-700">Off-Hours URL</label>
                    <input type="url" id="off_hours_url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="https://example.com">
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const onUrlsContainer = document.getElementById('on-urls-container');
            const addUrlBtn = document.getElementById('add-url-btn');
            const rotationTimeInput = document.getElementById('rotation_time_seconds');
            const startTimeInput = document.getElementById('on_hours_start');
            const endTimeInput = document.getElementById('on_hours_end');
            const offUrlInput = document.getElementById('off_hours_url');
            
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const statusSpinner = document.getElementById('status-spinner');

            // --- Status Functions ---
            const showLoading = (message) => {
                statusText.textContent = message || 'Loading...';
                statusIndicator.className = 'mb-6 p-4 rounded-lg flex items-center bg-blue-100 text-blue-800';
                statusSpinner.style.display = 'block';
            };

            const showSuccess = (message) => {
                statusText.textContent = message || 'Saved successfully!';
                statusIndicator.className = 'mb-6 p-4 rounded-lg flex items-center bg-green-100 text-green-800';
                statusSpinner.style.display = 'none';
            };

            const showError = (message) => {
                statusText.textContent = message || 'Error saving data.';
                statusIndicator.className = 'mb-6 p-4 rounded-lg flex items-center bg-red-100 text-red-800';
                statusSpinner.style.display = 'none';
            };

            // --- API Functions ---
            const api = {
                get: (endpoint) => fetch(endpoint).then(res => res.json()),
                post: (endpoint, data) => fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(res => res.json())
            };

            // --- Config Management ---
            let config = {};
            let saveTimeout;

            // Function to save the full config
            const saveConfig = async () => {
                showLoading('Saving...');
                try {
                    // Collect all data from the form
                    const onUrls = Array.from(document.querySelectorAll('.url-input'))
                                      .map(input => input.value)
                                      .filter(url => url.trim() !== ''); // Filter out empty strings
                    
                    const newConfig = {
                        on_urls: onUrls.length > 0 ? onUrls : config.on_urls, // Don't save an empty list if it was just loaded
                        rotation_time_seconds: parseInt(rotationTimeInput.value, 10) || 60,
                        on_hours_start: startTimeInput.value || '08:00',
                        on_hours_end: endTimeInput.value || '18:00',
                        off_hours_url: offUrlInput.value || ''
                    };
                    
                    const response = await api.post('/api/config', newConfig);
                    if (response.status === 'success') {
                        showSuccess('Configuration saved!');
                        config = newConfig; // Update local state
                        // Re-render URLs to remove any empty fields that were filtered out
                        renderOnUrls(config.on_urls);
                    } else {
                        showError(response.message);
                    }
                } catch (err) {
                    console.error('Save error:', err);
                    showError('Could not connect to server.');
                }
            };

            // Debounce function to delay saving
            const debouncedSave = () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveConfig, 1000); // Save 1 second after last change
            };

            // --- UI Rendering ---
            const createUrlInput = (url) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                
                const input = document.createElement('input');
                input.type = 'url';
                input.className = 'url-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500';
                input.value = url;
                input.placeholder = 'https://website.com';
                input.addEventListener('input', debouncedSave);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg text-lg';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    div.remove();
                    debouncedSave(); // Save after removing
                };
                
                div.appendChild(input);
                div.appendChild(removeBtn);
                return div;
            };

            const renderOnUrls = (urls) => {
                onUrlsContainer.innerHTML = ''; // Clear existing
                if (urls && urls.length > 0) {
                    urls.forEach(url => {
                        onUrlsContainer.appendChild(createUrlInput(url));
                    });
                } else {
                    // Add one empty box if no URLs are set
                    onUrlsContainer.appendChild(createUrlInput(''));
                }
            };

            // --- Load Initial Data ---
            const loadConfig = async () => {
                showLoading('Loading configuration...');
                try {
                    config = await api.get('/api/config');
                    
                    renderOnUrls(config.on_urls);
                    rotationTimeInput.value = config.rotation_time_seconds;
                    startTimeInput.value = config.on_hours_start;
                    endTimeInput.value = config.on_hours_end;
                    offUrlInput.value = config.off_hours_url;

                    showSuccess('Configuration loaded.');
                } catch (err) {
                    console.error('Load error:', err);
                    showError('Could not connect to server.');
                }
            };

            // --- Event Listeners ---
            addUrlBtn.onclick = () => {
                onUrlsContainer.appendChild(createUrlInput(''));
                // Focus the new input
                onUrlsContainer.lastChild.querySelector('input').focus();
            };

            // Add listeners to all main inputs
            [rotationTimeInput, startTimeInput, endTimeInput, offUrlInput].forEach(input => {
                input.addEventListener('input', debouncedSave);
            });

            // Initial load
            loadConfig();
        });
    </script>
</body>
</html>

