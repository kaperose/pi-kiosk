<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiosk Config</title>
    
    <!-- 
      CACHE BUSTING: 
      The ?v=1.1 query string is added to force your browser
      to re-download the CSS file instead of using an old, cached one.
    -->
    <link rel="stylesheet" href="/static/style.css?v=1.1">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="page-body">

    <div class="page-container">
        
        <!-- Header -->
        <header class="header">
            <div class="header-logo-container">
                <svg class="header-logo" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122l-1.178.943a1.125 1.125 0 01-1.766-.01l-1.122-1.122a1.125 1.125 0 010-1.59l4.564-4.564a1.125 1.125 0 011.59 0l4.564 4.564a1.125 1.125 0 010 1.59l-1.122 1.122a1.125 1.125 0 01-1.766.01l-1.178-.943A3 3 0 019 18.257v-1.007zM15 9.75a3 3 0 013-3h.008a3 3 0 013 3v.008a3 3 0 01-3 3h-.008a3 3 0 01-3-3V9.75z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 9.75a3 3 0 013-3h.008a3 3 0 013 3v.008a3 3 0 01-3 3h-.008a3 3 0 01-3-3V9.75z" />
                </svg>
            </div>
            <h1 class="header-title">Kiosk Config</h1>
            <p class="header-subtitle">Manage your kiosk display settings and schedules</p>
        </header>

        <!-- Status Message Box -->
        <div id="status-message" class="status-message" role="alert">
            <!-- Messages appear here -->
        </div>

        <!-- Main Config Card -->
        <main class="config-card">

            <!-- Display Schedule Section -->
            <section class="card-section">
                <div class="section-header">
                    <svg class="section-header-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h2 class="section-header-title">Display Schedule</h2>
                    <span id="schedule-status-badge" class="section-header-badge" style="display: none;">Active</span>
                </div>

                <div class="section-content form-grid">
                    <div class="form-group">
                        <label for="start-time" class="form-label">Start Time (24h)</label>
                        <div class="form-input-container">
                            <input type="time" id="start-time" class="form-input" />
                            <svg class="form-input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="end-time" class="form-label">End Time (24h)</label>
                        <div class="form-input-container">
                            <input type="time" id="end-time" class="form-input" />
                            <svg class="form-input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Content Rotation Section -->
            <section class="card-section">
                <div class="section-header">
                    <svg class="section-header-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                    </svg>
                    <h2 class="section-header-title">Content Rotation</h2>
                    <button id="add-url-btn" class="button-add">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        Add URL
                    </button>
                </div>

                <div id="url-list-container" class="section-content url-list-container">
                    <!-- URL entries will be dynamically inserted here -->
                </div>
            </section>

            <!-- Off-Hours Display URL Section -->
            <section class="card-section">
                <div class="form-group">
                    <label for="off-hours-url" class="form-label">Off Hours Display URL</label>
                    <p class="form-label-description">This page will be displayed outside operating hours</p>
                    <input type="text" id="off-hours-url" class="form-input" placeholder="https://offhours.site" />
                </div>
            </section>

            <!-- Action Buttons Footer -->
            <footer class="card-footer">
                <div class="footer-button-group">
                    <button id="restart-btn" class="button button-secondary">
                        <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                        Restart Kiosk
                    </button>
                    <!-- "Update from GitHub" button has been removed -->
                </div>
                
                <button id="save-btn" class="button button-primary">
                    <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                    </svg>
                    Save Changes
                </button>
            </footer>

        </main>

        <footer class="version-footer">
            <p>Version: <span id="app-version">Loading...</span></p>
            <p><a href="https://github.com/kaperose/pi-kiosk" target="_blank">View project on GitHub</a></p>
        </footer>
    </div>

    <!-- URL Entry Template (for JavaScript) -->
    <template id="url-entry-template">
        <div class="url-entry">
            <div class="form-group url-entry-group url-entry-group-url">
                <label class="form-label">URL</label>
                <input type="text" class="form-input url-input" placeholder="https://example.com">
            </div>
            <div class="form-group url-entry-group url-entry-group-duration">
                <label class="form-label">Duration (s)</label>
                <input type="number" class="form-input duration-input" value="60" min="5" max="3600">
            </div>
            <button class="button-remove" title="Remove URL">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.56 0c.342.052.682.107 1.022.166m11.538 0l-2.175 6.525a.375.375 0 01-.675.025L10.5 8.25l-2.175 6.525a.375.375 0 01-.675-.025L5.65 5.79m11.538 0M5.65 5.79l-.004-.004L5.644 5.786M5.65 5.79z" />
                </svg>
            </button>
        </div>
    </template>

    <script>
        // --- Constants and DOM Elements ---
        const API_URL = '/api/config';
        const RESTART_URL = '/api/restart';
        
        const saveBtn = document.getElementById('save-btn');
        const restartBtn = document.getElementById('restart-btn');
        const addUrlBtn = document.getElementById('add-url-btn');
        const urlListContainer = document.getElementById('url-list-container');
        const urlEntryTemplate = document.getElementById('url-entry-template');
        
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        const offHoursUrlInput = document.getElementById('off-hours-url');
        
        const statusMessage = document.getElementById('status-message');
        const scheduleStatusBadge = document.getElementById('schedule-status-badge');
        const appVersionSpan = document.getElementById('app-version'); // For displaying version

        // Define a simple version
        const APP_VERSION = "1.1.0"; // Incremented version
        appVersionSpan.textContent = APP_VERSION;

        // Store original button content for loading states
        const saveBtnOriginalContent = saveBtn.innerHTML;
        const restartBtnOriginalContent = restartBtn.innerHTML;


        // --- Utility Functions ---
        
        function showStatus(message, type = 'loading') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message visible status-${type}`;
        }
        
        function hideStatus() {
            statusMessage.textContent = '';
            statusMessage.className = 'status-message';
        }

        function setButtonLoading(btn) {
            btn.disabled = true;
            btn.innerHTML = `<div class="spinner"></div> Processing...`;
        }

        function resetButton(btn, originalContent) {
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }

        // --- Core Functions ---

        /**
         * Loads the current config from the server and populates the form
         */
        async function loadConfig() {
            showStatus('Loading configuration...', 'loading');
            try {
                // Add a random query string to bypass browser cache for this API call
                const response = await fetch(`${API_URL}?_=${new Date().getTime()}`);
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }
                const config = await response.json();
                
                // Populate schedule
                startTimeInput.value = config.on_hours_start;
                endTimeInput.value = config.on_hours_end;
                
                // Populate off-hours URL
                offHoursUrlInput.value = config.off_hours_url;

                // Populate URL list
                urlListContainer.innerHTML = ''; // Clear existing
                if (config.on_urls && config.on_urls.length > 0) {
                    config.on_urls.forEach((entry, index) => addUrlEntry(entry.url, entry.duration, index + 1));
                } else {
                    // Add one blank entry if none exist
                    addUrlEntry('', 60, 1);
                }
                
                updateScheduleStatus();
                hideStatus();
                
            } catch (error) {
                console.error('Error loading config:', error);
                showStatus(`Error loading config: ${error.message}`, 'error');
            }
        }

        /**
         * Gathers data from the form and saves it to the server
         */
        async function saveConfig() {
            setButtonLoading(saveBtn);
            showStatus('Saving changes...', 'loading');

            // Collect "on" URLs
            const onUrls = [];
            const urlEntries = urlListContainer.querySelectorAll('.url-entry');
            urlEntries.forEach(entry => {
                const url = entry.querySelector('.url-input').value.trim();
                const duration = parseInt(entry.querySelector('.duration-input').value, 10) || 60;
                if (url) { // Only add if URL is not empty
                    onUrls.push({ url, duration });
                }
            });

            // Construct config object
            const configData = {
                on_hours_start: startTimeInput.value,
                on_hours_end: endTimeInput.value,
                off_hours_url: offHoursUrlInput.value.trim(),
                on_urls: onUrls
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || `Server responded with ${response.status}`);
                }
                
                showStatus(result.message, 'success');
                
            } catch (error) {
                console.error('Error saving config:', error);
                showStatus(`Error saving config: ${error.message}`, 'error');
            } finally {
                resetButton(saveBtn, saveBtnOriginalContent);
                // Hide success/error message after 3 seconds
                setTimeout(hideStatus, 3000);
            }
        }

        /**
         * Sends a request to restart the kiosk service
         */
        async function restartKiosk() {
            if (!confirm('Are you sure you want to restart the kiosk display?')) {
                return;
            }
            
            setButtonLoading(restartBtn);
            showStatus('Sending restart command...', 'loading');

            try {
                const response = await fetch(RESTART_URL, { method: 'POST' });
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || `Server responded with ${response.status}`);
                }
                
                showStatus(result.message, 'success');
                
            } catch (error) {
                console.error('Error restarting kiosk:', error);
                showStatus(`Error restarting kiosk: ${error.message}`, 'error');
            } finally {
                resetButton(restartBtn, restartBtnOriginalContent);
                setTimeout(hideStatus, 3000);
            }
        }
        
        /**
         * Creates and adds a new URL entry row to the UI
         */
        function addUrlEntry(url = '', duration = 60, number) {
            const templateClone = urlEntryTemplate.content.cloneNode(true);
            const urlEntry = templateClone.querySelector('.url-entry');
            
            urlEntry.querySelector('.url-input').value = url;
            urlEntry.querySelector('.duration-input').value = duration;
            
            // Update the URL label to show "URL 1", "URL 2", etc.
            const urlLabel = urlEntry.querySelector('.form-group.url-entry-group-url .form-label');
            if (urlLabel) {
                urlLabel.textContent = `URL ${number}`;
            }

            const removeButton = urlEntry.querySelector('.button-remove');
            removeButton.addEventListener('click', () => {
                // Prevent removing the last item if only one remains
                if (urlListContainer.querySelectorAll('.url-entry').length > 1) {
                    urlEntry.remove();
                    // Re-number URLs after removal
                    updateUrlEntryNumbers();
                } else {
                    showStatus('You must have at least one URL entry.', 'error');
                    setTimeout(hideStatus, 3000);
                }
            });
            
            urlListContainer.appendChild(urlEntry);
        }

        /**
         * Re-numbers the URL entries after an addition or removal
         */
        function updateUrlEntryNumbers() {
            const urlEntries = urlListContainer.querySelectorAll('.url-entry');
            urlEntries.forEach((entry, index) => {
                const urlLabel = entry.querySelector('.form-group.url-entry-group-url .form-label');
                if (urlLabel) {
                    urlLabel.textContent = `URL ${index + 1}`;
                }
            });
        }


        /**
         * Checks if the kiosk is currently "ON" or "OFF" and updates the badge
         */
        function updateScheduleStatus() {
            try {
                const now = new Date();
                const currentTime = now.toTimeString().slice(0, 5); // "HH:MM"
                
                const start = startTimeInput.value;
                const end = endTimeInput.value;

                let isActive = false;
                if (start && end) {
                    if (start < end) {
                        // Simple case: 08:00 - 18:00
                        isActive = currentTime >= start && currentTime < end;
                    } else {
                        // Overnight case: 22:00 - 06:00
                        isActive = currentTime >= start || currentTime < end;
                    }
                }
                
                if (isActive) {
                    scheduleStatusBadge.textContent = 'Active';
                    scheduleStatusBadge.style.backgroundColor = '#d1fae5'; // bg-green-100
                    scheduleStatusBadge.style.color = '#065f46'; // text-green-800
                } else {
                    scheduleStatusBadge.textContent = 'Off-Hours';
                    scheduleStatusBadge.style.backgroundColor = '#fee2e2'; // bg-red-100
                    scheduleStatusBadge.style.color = '#991b1b'; // text-red-700
                }
                scheduleStatusBadge.style.display = 'inline-block';
                
            } catch (e) {
                console.error("Could not update schedule status:", e);
                scheduleStatusBadge.style.display = 'none';
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', loadConfig);
        saveBtn.addEventListener('click', saveConfig);
        restartBtn.addEventListener('click', restartKiosk);
        addUrlBtn.addEventListener('click', () => addUrlEntry('', 60, urlListContainer.querySelectorAll('.url-entry').length + 1));

        // Update the status badge every 10 seconds and also when times change
        setInterval(updateScheduleStatus, 10000);
        startTimeInput.addEventListener('change', updateScheduleStatus);
        endTimeInput.addEventListener('change', updateScheduleStatus);
        
    </script>
</body>
</html>

