<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiosk Config</title>
    
    <!-- External CSS link removed -->
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- NEW: Add Sortable.js library for drag-and-drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" xintegrity="sha512-Eezs+g9LqAeoqknMMupTssJirYkiI0uPullRjji9AUHNPJstTBHSSVjdEZ-NULLglnfeowbqsYHIUmcdeTA5UA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- All styles are now inline inside this <style> tag -->
    <style>
        /* --- Base & Reset --- */
        :root {
            --color-primary: #4f46e5; /* indigo-600 */
            --color-primary-hover: #4338ca; /* indigo-700 */
            --color-primary-text: #ffffff;
            
            --color-secondary: #ffffff;
            --color-secondary-hover: #f9fafb; /* gray-50 */
            --color-secondary-text: #374151; /* gray-700 */
            --color-secondary-border: #d1d5db; /* gray-300 */
            
            --color-danger: #ef4444; /* red-500 */
            --color-danger-hover: #fee2e2; /* red-100 */
            --color-danger-text: #b91c1c; /* red-700 */

            --color-add-url: #3b82f6; /* blue-500 */
            --color-add-url-hover: #dbeafe; /* blue-100 */

            --color-text-base: #374151; /* gray-700 */
            --color-text-light: #6b7280; /* gray-500 */
            --color-text-header: #111827; /* gray-900 */
            
            --color-bg-page: #f9fafb; /* gray-50 */
            --color-bg-card: #ffffff;
            --color-border: #e5e7eb; /* gray-200 */
            
            --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Page Layout --- */
        .page-body {
            font-family: var(--font-family-sans);
            background-color: var(--color-bg-page);
            color: var(--color-text-base);
            min-height: 100vh;
            padding: 2rem;
        }

        .page-container {
            max-width: 48rem; /* max-w-3xl */
            margin: 0 auto;
        }
        
        /* --- Header --- */
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .header-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3.5rem; /* w-14 */
            height: 3.5rem; /* h-14 */
            background-image: linear-gradient(to right, #4f46e5, #7c3aed); /* bg-gradient-to-r from-indigo-600 to-purple-600 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: var(--shadow);
            padding: 0.75rem; /* p-3 */
        }
        .header-logo {
            width: 100%;
            height: 100%;
            color: var(--color-primary-text);
        }
        .header-title {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700;
            color: var(--color-text-header);
            margin-top: 1rem;
        }
        .header-subtitle {
            font-size: 1.125rem; /* text-lg */
            color: var(--color-text-light);
            margin-top: 0.25rem;
        }

        /* --- Status Message --- */
        .status-message {
            padding: 1rem;
            border-radius: 0.5rem; /* rounded-md */
            font-weight: 500;
            margin-bottom: 1.5rem;
            display: none; /* Hidden by default */
        }
        .status-message.visible {
            display: block;
        }
        .status-message.status-success {
            background-color: #d1fae5; /* bg-green-100 */
            color: #065f46; /* text-green-800 */
        }
        .status-message.status-error {
            background-color: #fee2e2; /* bg-red-100 */
            color: #991b1b; /* text-red-700 */
        }
        .status-message.status-loading {
            background-color: #dbeafe; /* bg-blue-100 */
            color: #1e40af; /* text-blue-800 */
        }

        /* --- Config Card --- */
        .config-card {
            background-color: var(--color-bg-card);
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: var(--shadow-lg);
            padding: 2rem;
        }
        /* This applies margin-top to every section *after* the first one */
        .config-card > .card-section + .card-section {
            margin-top: 2.5rem;
        }

        .card-section {
            /* Spacing is handled by the parent */
        }

        /* --- Section Header --- */
        .section-header {
            display: flex;
            align-items: center;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1.5rem;
        }
        .section-header-icon {
            width: 1.25rem;
            height: 1.25rem;
            color: var(--color-primary);
            margin-right: 0.5rem;
        }
        .section-header-title {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600;
            color: var(--color-text-header);
            flex-grow: 1; /* Pushes badge to the right */
        }
        .section-header-badge {
            font-size: 0.75rem; /* text-xs */
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* rounded-full */
            text-transform: uppercase;
        }

        .section-content {
            /* container for form elements */
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr; /* 1 col by default */
            gap: 1.5rem;
        }

        /* --- Form Elements --- */
        .form-group {
            /* container for label, description, input */
        }
        .form-label {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            color: var(--color-text-base);
            margin-bottom: 0.5rem;
        }
        .form-label-description {
            font-size: 0.875rem;
            color: var(--color-text-light);
            margin-bottom: 0.5rem;
        }
        .form-input-container {
            position: relative;
        }
        .form-input {
            display: block;
            width: 100%;
            border: 1px solid var(--color-secondary-border);
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem;
            font-size: 1rem;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); /* shadow-sm */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }
        .form-input-icon {
            position: absolute;
            top: 50%;
            right: 0.75rem;
            transform: translateY(-50%);
            width: 1.25rem;
            height: 1.25rem;
            color: var(--color-text-light);
            pointer-events: none;
        }
        /* Hide default time/number icons in WebKit */
        input[type="time"]::-webkit-calendar-picker-indicator {
            display: none;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0; 
        }

        /* --- Content Rotation (URL List) --- */
        .button-add {
            display: inline-flex;
            align-items: center;
            background-color: transparent;
            border: none;
            color: var(--color-add-url);
            font-weight: 500;
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .button-add:hover {
            background-color: var(--color-add-url-hover);
        }
        .button-add svg {
            width: 1rem;
            height: 1rem;
            margin-right: 0.25rem;
        }
        
        .url-list-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .url-entry {
            display: grid;
            /* Mobile: handle, url, duration, remove */
            grid-template-columns: auto 1fr auto; /* Handle, URL, Remove */
            grid-template-areas: 
                "handle url remove"
                "handle duration remove";
            gap: 0.5rem 1rem;
            padding: 1.25rem;
            border: 1px solid var(--color-border);
            border-radius: 0.75rem; /* rounded-xl */
            background-color: var(--color-bg-page); /* gray-50 */
            align-items: center;
        }
        .button-remove {
            grid-area: remove;
            justify-self: center;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-secondary);
            color: var(--color-danger);
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            width: 2.5rem; /* h-10, w-10 */
            height: 2.5rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .button-remove:hover {
            background-color: var(--color-danger-hover);
            color: var(--color-danger-text);
        }
        .button-remove svg {
            width: 1.25rem;
            height: 1.25rem;
        }
        
        /* --- NEW: Drag & Drop Styles --- */
        .drag-handle {
            grid-area: handle;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            color: var(--color-text-light);
            width: 2.5rem;
            height: 100%; /* Fill height of cell */
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        /* Classes added by Sortable.js */
        .url-entry.sortable-ghost {
            opacity: 0.4;
            background-color: #dbeafe; /* blue-100 */
        }
        .url-entry.sortable-chosen {
            box-shadow: var(--shadow);
            background-color: #eff6ff; /* blue-50 */
        }
        .url-entry-group-url {
            grid-area: url;
        }
        .url-entry-group-duration {
            grid-area: duration;
        }


        /* --- Card Footer & Buttons --- */
        .card-footer {
            display: flex;
            flex-direction: column; /* Mobile: stack buttons */
            gap: 1rem;
            padding-top: 1.5rem;
            margin-top: 2.5rem;
            border-top: 1px solid var(--color-border);
        }
        .footer-button-group {
            display: flex;
            flex-direction: column; /* Mobile: stack buttons */
            gap: 1rem;
        }
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem; /* text-sm */
            padding: 0.625rem 1.25rem; /* py-2.5 px-5 */
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid transparent;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
        }
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .button-icon {
            width: 1.125rem; /* w-4.5 */
            height: 1.125rem; /* h-4.5 */
            margin-right: 0.5rem;
        }
        
        .button-primary {
            background-color: var(--color-primary);
            color: var(--color-primary-text);
        }
        .button-primary:hover:not(:disabled) {
            background-color: var(--color-primary-hover);
        }
        .button-primary:focus {
             outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4);
        }
        
        .button-secondary {
            background-color: var(--color-secondary);
            color: var(--color-secondary-text);
            border-color: var(--color-secondary-border);
            box-shadow: var(--shadow);
        }
        .button-secondary:hover:not(:disabled) {
            background-color: var(--color-secondary-hover);
        }
        .button-secondary:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }
        
        /* --- Version Footer --- */
        .version-footer {
            text-align: center;
            margin-top: 2rem;
            font-size: 0.875rem;
            color: var(--color-text-light);
        }
        .version-footer p {
            margin-bottom: 0.25rem;
        }
        .version-footer a {
            color: var(--color-primary);
            text-decoration: none;
        }
        .version-footer a:hover {
            text-decoration: underline;
        }

        /* --- Spinner Animation --- */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 1.125rem;
            height: 1.125rem;
            border-radius: 50%;
            border-left-color: currentColor; /* Uses button's text color */
            animation: spin 1s ease infinite;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        /* --- Responsive Tablet/Desktop Styles --- */
        @media (min-width: 640px) { /* sm: */
            .form-grid {
                grid-template-columns: repeat(2, 1fr); /* 2 cols */
            }
            
            .url-entry {
                /* Handle, URL (6 parts), Duration (3 parts), Button (auto) */
                grid-template-columns: auto 6fr 3fr auto;
                grid-template-areas: "handle url duration remove"; /* Single row */
                align-items: flex-end; /* Aligns button with inputs */
                gap: 0 1rem;
            }
            /* Hide labels for grid view, they are now headers (implied) */
            .url-entry .form-label {
                /* This is a bit of a hack to hide them visually but keep for screen readers */
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border-width: 0;
            }
            /* We show the first row's labels as headers */
            .url-list-container .url-entry:first-child .form-label {
                position: static;
                width: auto;
                height: auto;
                padding: 0;
                margin: 0;
                overflow: visible;
                clip: auto;
                white-space: normal;
                margin-bottom: 0.5rem;
            }
            
            .card-footer {
                flex-direction: row; /* Desktop: side-by-side */
                justify-content: space-between;
                align-items: center;
            }
            .footer-button-group {
                flex-direction: row;
            }
        }

    </style>
</head>
<body class="page-body">

    <div class="page-container">
        
        <!-- Header -->
        <header class="header">
            <div class="header-logo-container">
                <svg class="header-logo" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122l-1.178.943a1.125 1.125 0 01-1.766-.01l-1.122-1.122a1.125 1.125 0 010-1.59l4.564-4.564a1.125 1.125 0 011.59 0l4.564 4.564a1.125 1.125 0 010 1.59l-1.122 1.122a1.125 1.125 0 01-1.766.01l-1.178-.943A3 3 0 019 18.257v-1.007zM15 9.75a3 3 0 013-3h.008a3 3 0 013 3v.008a3 3 0 01-3 3h-.008a3 3 0 01-3-3V9.75z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 9.75a3 3 0 013-3h.008a3 3 0 013 3v.008a3 3 0 01-3 3h-.008a3 3 0 01-3-3V9.75z" />
                </svg>
            </div>
            <h1 class="header-title">Kiosk Config</h1>
            <p class="header-subtitle">Manage your kiosk display settings and schedules</p>
        </header>

        <!-- Status Message Box -->
        <div id="status-message" class="status-message" role="alert">
            <!-- Messages appear here -->
        </div>

        <!-- Main Config Card -->
        <main class="config-card">

            <!-- Display Schedule Section -->
            <section class="card-section">
                <div class="section-header">
                    <svg class="section-header-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h2 class="section-header-title">Display Schedule</h2>
                    <span id="schedule-status-badge" class="section-header-badge" style="display: none;">Active</span>
                </div>

                <div class="section-content form-grid">
                    <div class="form-group">
                        <label for="start-time" class="form-label">Start Time (24h)</label>
                        <div class="form-input-container">
                            <input type="time" id="start-time" class="form-input" />
                            <svg class="form-input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="end-time" class="form-label">End Time (24h)</label>
                        <div class="form-input-container">
                            <input type="time" id="end-time" class="form-input" />
                            <svg class="form-input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Content Rotation Section -->
            <section class="card-section">
                <div class="section-header">
                    <svg class="section-header-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                    </svg>
                    <h2 class="section-header-title">Content Rotation</h2>
                    <button id="add-url-btn" class="button-add">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        Add URL
                    </button>
                </div>

                <div id="url-list-container" class="section-content url-list-container">
                    <!-- URL entries will be dynamically inserted here -->
                </div>
            </section>

            <!-- Off-Hours Display URL Section -->
            <section class="card-section">
                <div class="form-group">
                    <label for="off-hours-url" class="form-label">Off Hours Display URL</label>
                    <p class="form-label-description">This page will be displayed outside operating hours</p>
                    <input type="text" id="off-hours-url" class="form-input" placeholder="https://offhours.site" />
                </div>
            </section>

            <!-- Action Buttons Footer -->
            <footer class="card-footer">
                <div class="footer-button-group">
                    <button id="restart-btn" class="button button-secondary">
                        <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                        Restart Kiosk
                    </button>
                    <!-- "Update from GitHub" button has been removed -->
                </div>
                
                <button id="save-btn" class="button button-primary">
                    <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                    </svg>
                    Save Changes
                </button>
            </footer>

        </main>

        <footer class="version-footer">
            <p>Version: <span id="app-version">Loading...</span></p>
            <p><a href="https://github.com/kaperose/pi-kiosk" target="_blank">View project on GitHub</a></p>
        </footer>
    </div>

    <!-- URL Entry Template (for JavaScript) -->
    <template id="url-entry-template">
        <div class="url-entry">
            <!-- NEW: Drag Handle -->
            <div class="drag-handle" title="Drag to reorder">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                </svg>
            </div>
            
            <div class="form-group url-entry-group url-entry-group-url">
                <label class="form-label">URL</label>
                <input type="text" class="form-input url-input" placeholder="https://example.com">
            </div>
            <div class="form-group url-entry-group url-entry-group-duration">
                <label class="form-label">Duration (s)</label>
                <input type="number" class="form-input duration-input" value="60" min="5" max="3600">
            </div>
            <button class="button-remove" title="Remove URL">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.56 0c.342.052.682.107 1.022.166m11.538 0l-2.175 6.525a.375.375 0 01-.675.025L10.5 8.25l-2.175 6.525a.375.375 0 01-.675-.025L5.65 5.79m11.538 0M5.65 5.79l-.004-.004L5.644 5.786M5.65 5.79z" />
                </svg>
            </button>
        </div>
    </template>

    <script>
        // --- Constants and DOM Elements ---
        const API_URL = '/api/config';
        const RESTART_URL = '/api/restart';
        
        const saveBtn = document.getElementById('save-btn');
        const restartBtn = document.getElementById('restart-btn');
        const addUrlBtn = document.getElementById('add-url-btn');
        const urlListContainer = document.getElementById('url-list-container');
        const urlEntryTemplate = document.getElementById('url-entry-template');
        
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        const offHoursUrlInput = document.getElementById('off-hours-url');
        
        const statusMessage = document.getElementById('status-message');
        const scheduleStatusBadge = document.getElementById('schedule-status-badge');
        const appVersionSpan = document.getElementById('app-version'); // For displaying version

        // Define a simple version
        const APP_VERSION = "1.3.0"; // Incremented version for drag-drop
        appVersionSpan.textContent = APP_VERSION;

        // Store original button content for loading states
        const saveBtnOriginalContent = saveBtn.innerHTML;
        const restartBtnOriginalContent = restartBtn.innerHTML;

        // --- NEW: Initialize Sortable.js ---
        new Sortable(urlListContainer, {
            animation: 150,
            handle: '.drag-handle', // Specify the drag handle
            ghostClass: 'sortable-ghost', // Class for the ghost element
            chosenClass: 'sortable-chosen', // Class for the chosen item
            onEnd: function (evt) {
                // Fired when the user finishes dragging
                // Re-number the URL labels
                updateUrlEntryNumbers();
            }
        });

        // --- Utility Functions ---
        
        function showStatus(message, type = 'loading') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message visible status-${type}`;
        }
        
        function hideStatus() {
            statusMessage.textContent = '';
            statusMessage.className = 'status-message';
        }

        function setButtonLoading(btn) {
            btn.disabled = true;
            btn.innerHTML = `<div class="spinner"></div> Processing...`;
        }

        function resetButton(btn, originalContent) {
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }

        // --- Core Functions ---

        /**
         * Loads the current config from the server and populates the form
         */
        async function loadConfig() {
            showStatus('Loading configuration...', 'loading');
            try {
                // Add a random query string to bypass browser cache for this API call
                const response = await fetch(`${API_URL}?_=${new Date().getTime()}`);
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }
                const config = await response.json();
                
                // Populate schedule
                startTimeInput.value = config.on_hours_start;
                endTimeInput.value = config.on_hours_end;
                
                // Populate off-hours URL
                offHoursUrlInput.value = config.off_hours_url;

                // Populate URL list
                urlListContainer.innerHTML = ''; // Clear existing
                if (config.on_urls && config.on_urls.length > 0) {
                    config.on_urls.forEach((entry, index) => addUrlEntry(entry.url, entry.duration, index + 1));
                } else {
                    // Add one blank entry if none exist
                    addUrlEntry('', 60, 1);
                }
                
                updateScheduleStatus();
                hideStatus();
                
            } catch (error) {
                console.error('Error loading config:', error);
                showStatus(`Error loading config: ${error.message}`, 'error');
            }
        }

        /**
         * Gathers data from the form and saves it to the server
         */
        async function saveConfig() {
            setButtonLoading(saveBtn);
            showStatus('Saving changes...', 'loading');

            // Collect "on" URLs
            const onUrls = [];
            // Read the entries *in their current order*
            const urlEntries = urlListContainer.querySelectorAll('.url-entry');
            urlEntries.forEach(entry => {
                const url = entry.querySelector('.url-input').value.trim();
                const duration = parseInt(entry.querySelector('.duration-input').value, 10) || 60;
                if (url) { // Only add if URL is not empty
                    onUrls.push({ url, duration });
                }
            });

            // Construct config object
            const configData = {
                on_hours_start: startTimeInput.value,
                on_hours_end: endTimeInput.value,
                off_hours_url: offHoursUrlInput.value.trim(),
                on_urls: onUrls
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || `Server responded with ${response.status}`);
                }
                
                showStatus(result.message, 'success');
                
            } catch (error) {
                console.error('Error saving config:', error);
                showStatus(`Error saving config: ${error.message}`, 'error');
            } finally {
                resetButton(saveBtn, saveBtnOriginalContent);
                // Hide success/error message after 3 seconds
                setTimeout(hideStatus, 3000);
            }
        }

        /**
         * Sends a request to restart the kiosk service
         */
        async function restartKiosk() {
            if (!confirm('Are you sure you want to restart the kiosk display?')) {
                return;
            }
            
            setButtonLoading(restartBtn);
            showStatus('Sending restart command...', 'loading');

            try {
                const response = await fetch(RESTART_URL, { method: 'POST' });
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || `Server responded with ${response.status}`);
                }
                
                showStatus(result.message, 'success');
                
            } catch (error) {
                console.error('Error restarting kiosk:', error);
                showStatus(`Error restarting kiosk: ${error.message}`, 'error');
            } finally {
                resetButton(restartBtn, restartBtnOriginalContent);
                setTimeout(hideStatus, 3000);
            }
        }
        
        /**
         * Creates and adds a new URL entry row to the UI
         */
        function addUrlEntry(url = '', duration = 60, number) {
            const templateClone = urlEntryTemplate.content.cloneNode(true);
            const urlEntry = templateClone.querySelector('.url-entry');
            
            urlEntry.querySelector('.url-input').value = url;
            urlEntry.querySelector('.duration-input').value = duration;
            
            // Update the URL label to show "URL 1", "URL 2", etc.
            const urlLabel = urlEntry.querySelector('.form-group.url-entry-group-url .form-label');
            if (urlLabel) {
                urlLabel.textContent = `URL ${number}`;
            }

            const removeButton = urlEntry.querySelector('.button-remove');
            removeButton.addEventListener('click', () => {
                // Prevent removing the last item if only one remains
                if (urlListContainer.querySelectorAll('.url-entry').length > 1) {
                    urlEntry.remove();
                    // Re-number URLs after removal
                    updateUrlEntryNumbers();
                } else {
                    showStatus('You must have at least one URL entry.', 'error');
                    setTimeout(hideStatus, 3000);
                }
            });
            
            urlListContainer.appendChild(urlEntry);
        }

        /**
         * Re-numbers the URL entries after an addition or removal
         */
        function updateUrlEntryNumbers() {
            const urlEntries = urlListContainer.querySelectorAll('.url-entry');
            urlEntries.forEach((entry, index) => {
                const urlLabel = entry.querySelector('.form-group.url-entry-group-url .form-label');
                if (urlLabel) {
                    urlLabel.textContent = `URL ${index + 1}`;
                }
            });
        }


        /**
         * Checks if the kiosk is currently "ON" or "OFF" and updates the badge
         */
        function updateScheduleStatus() {
            try {
                const now = new Date();
                const currentTime = now.toTimeString().slice(0, 5); // "HH:MM"
                
                const start = startTimeInput.value;
                const end = endTimeInput.value;

                let isActive = false;
                if (start && end) {
                    if (start < end) {
                        // Simple case: 08:00 - 18:00
                        isActive = currentTime >= start && currentTime < end;
                    } else {
                        // Overnight case: 22:00 - 06:00
                        isActive = currentTime >= start || currentTime < end;
                    }
                }
                
                if (isActive) {
                    scheduleStatusBadge.textContent = 'Active';
                    scheduleStatusBadge.style.backgroundColor = '#d1fae5'; // bg-green-100
                    scheduleStatusBadge.style.color = '#065f46'; // text-green-800
                } else {
                    scheduleStatusBadge.textContent = 'Off-Hours';
                    scheduleStatusBadge.style.backgroundColor = '#fee2e2'; // bg-red-100
                    scheduleStatusBadge.style.color = '#991b1b'; // text-red-700
                }
                scheduleStatusBadge.style.display = 'inline-block';
                
            } catch (e) {
                console.error("Could not update schedule status:", e);
                scheduleStatusBadge.style.display = 'none';
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', loadConfig);
        saveBtn.addEventListener('click', saveConfig);
        restartBtn.addEventListener('click', restartKiosk);
        addUrlBtn.addEventListener('click', () => {
            addUrlEntry('', 60, urlListContainer.querySelectorAll('.url-entry').length + 1)
            // Re-number just in case (e.g., if user deleted all but one)
            updateUrlEntryNumbers();
        });

        // Update the status badge every 10 seconds and also when times change
        setInterval(updateScheduleStatus, 10000);
        startTimeInput.addEventListener('change', updateScheduleStatus);
        endTimeInput.addEventListener('change', updateScheduleStatus);
        
    </script>
</body>
</html>

